import { approxLinesChanged } from "./patch.js";
const ROUTER_FILE = "src/routes.tsx";
const IMPORTS_START = "// @webspec:imports:start";
const IMPORTS_END = "// @webspec:imports:end";
const ROUTES_START = "// @webspec:routes:start";
const ROUTES_END = "// @webspec:routes:end";
function pageFile(name) {
    return `src/pages/${name}.tsx`;
}
function pascalSafe(name) {
    return name.replace(/[^a-zA-Z0-9]/g, "");
}
function normalizeRoute(routeHint) {
    if (!routeHint.startsWith("/"))
        return `/${routeHint}`;
    return routeHint;
}
function pageTemplate(page) {
    const title = page.title;
    const sections = page.sections ?? [
        { type: "heading", text: title },
        { type: "paragraph", text: "Generated by WebSpec." },
    ];
    const body = sections.map((s) => {
        if (s.type === "heading")
            return `<h1 className=\"text-2xl font-semibold\">${escapeHtml(s.text)}</h1>`;
        if (s.type === "callout")
            return `<div className=\"rounded-lg border p-4\">${escapeHtml(s.text)}</div>`;
        return `<p className=\"opacity-80\">${escapeHtml(s.text)}</p>`;
    }).join("\n      ");
    return `export default function ${pascalSafe(page.name)}() {
  return (
    <main className="mx-auto max-w-3xl p-6 space-y-4">
      ${body}
    </main>
  );
}
`;
}
function escapeHtml(s) {
    return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}
function routerSkeleton() {
    return `import React from "react";
// @webspec:imports:start
import Home from "./pages/Home";
// @webspec:imports:end

export type AppRoute = { path: string; element: React.ReactNode };

export const routes: AppRoute[] = [
  // @webspec:routes:start
  { path: "/", element: <Home /> },
  // @webspec:routes:end
];
`;
}
export async function compileViteReactIntent(intent, ws) {
    const diagnostics = [];
    const steps = [];
    const hasRouter = await ws.exists(ROUTER_FILE);
    if (!hasRouter) {
        steps.push({ kind: "writeFile", path: ROUTER_FILE, content: routerSkeleton() });
    }
    for (const p of intent.intent.pages) {
        const route = normalizeRoute(p.routeHint);
        const file = pageFile(p.name);
        const exists = await ws.exists(file);
        if (!exists) {
            steps.push({ kind: "writeFile", path: file, content: pageTemplate(p) });
        }
        const importLine = `import ${pascalSafe(p.name)} from "./pages/${p.name}";`;
        steps.push({
            kind: "insertBetweenMarkers",
            path: ROUTER_FILE,
            markerStart: IMPORTS_START,
            markerEnd: IMPORTS_END,
            content: importLine,
            uniqueKey: importLine,
        });
        const routeLine = `{ path: "${route}", element: <${pascalSafe(p.name)} /> },`;
        steps.push({
            kind: "insertBetweenMarkers",
            path: ROUTER_FILE,
            markerStart: ROUTES_START,
            markerEnd: ROUTES_END,
            content: routeLine,
            uniqueKey: routeLine,
        });
        steps.push({ kind: "assertFileExists", path: file });
        steps.push({ kind: "assertFileContains", path: ROUTER_FILE, needle: `path: "${route}"` });
        steps.push({ kind: "assertFileContains", path: ROUTER_FILE, needle: importLine });
    }
    const touched = new Set();
    let newFiles = 0;
    for (const s of steps) {
        if ("path" in s)
            touched.add(s.path);
        if (s.kind === "writeFile") {
            newFiles += 1;
        }
    }
    const plan = {
        target: "react-vite-shadcn-tailwind4",
        steps,
        predictedImpact: {
            filesTouched: touched.size,
            newFiles,
            routerTouched: true,
            configTouched: false,
            depsTouched: false,
            approxLinesChanged: approxLinesChanged({
                target: "react-vite-shadcn-tailwind4",
                steps,
                predictedImpact: {
                    filesTouched: 0,
                    newFiles: 0,
                    routerTouched: false,
                    configTouched: false,
                    depsTouched: false,
                    approxLinesChanged: 0,
                }
            }),
        },
    };
    if (hasRouter) {
        const router = await ws.read(ROUTER_FILE);
        const okMarkers = router.includes(IMPORTS_START) && router.includes(IMPORTS_END) && router.includes(ROUTES_START) && router.includes(ROUTES_END);
        if (!okMarkers) {
            diagnostics.push({
                level: "error",
                code: "E_ROUTER_MARKERS",
                message: `Router file missing WebSpec markers: ${ROUTER_FILE}`,
                hint: `Add markers (${IMPORTS_START}...${IMPORTS_END} and ${ROUTES_START}...${ROUTES_END}) or let WebSpec generate a new router file.`,
            });
            return { diagnostics };
        }
    }
    return { plan, diagnostics };
}
//# sourceMappingURL=kernel_vite.js.map